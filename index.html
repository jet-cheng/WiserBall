<!doctype html>
<html lang="zh-Hant">
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wiser Ball â€” è¨ˆåˆ†å™¨</title>
<style>
  /* ===== å…¨åŸŸæ¨£å¼ ===== */
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto;
    padding: 16px;
    max-width: 1100px;
    margin: auto;
    background: #fdfdfd;
  }
  h1, h3, h4 {
    margin: 6px 0 12px;
  }
  .row {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }
  select, input, button {
    font-size: 15px;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  .btn {
    font-size: 16px;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn:disabled {
    background-color: #aaa !important;
    cursor: not-allowed;
  }
  #btnInit { background-color: #4CAF50; }  /* ç¶ è‰² */
  #btnHit { background-color: #2196F3; }   /* è—è‰² */
  #btnUndo { background-color: #FF9800; }  /* æ©˜è‰² */
  #btnCalc { background-color: #F44336; }  /* ç´…è‰² */
  #btnPdf { background-color: #2196F3; }   /* è—è‰² */
  .danger { background:#d9534f; }

  /* ===== Header å€å¡Š ===== */
  .header-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .timer-block {
    font-size: 24px;
    font-weight: bold;
    color: #d32f2f;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .timer-block button {
    font-size: 16px;
    padding: 6px 10px;
  }

  /* ===== æ¯”è³½è³‡è¨Šè¡¨æ ¼ ===== */
  .match-info {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
  }
  .match-info td {
    border: 1px solid #ccc;
    padding: 6px;
    word-break: break-word;
    vertical-align: top;
  }
  .match-info input {
    width: 100%;
    box-sizing: border-box;
  }
  @media(max-width: 600px) {
    .match-info, .match-info tr, .match-info td {
      display: block;
      width: 100%;
    }
    .match-info td {
      margin-bottom: 6px;
    }
  }

  /* ===== è¨ˆåˆ†æ¿èˆ‡çƒç‹€æ…‹ ===== */
  .board {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 12px;
  }
  .team-card {
    border: 1px solid #ddd;
    padding: 12px;
    border-radius: 8px;
    flex: 1;
    background: #fff;
  }
  .balls {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .ball {
    width: 80px;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #bbb;
    text-align: center;
    background: #fff;
  }
  .s0 { background:#fff }       /* ç«¶æŠ€çƒ */
  .s1 { background:#fff7c0 }   /* åˆé—œ(é»ƒ) */
  .s2 { background:#ffd0d0 }   /* äºŒé—œ(ç´…) */
  .s3 { background:#eee; text-decoration: line-through } /* æ·˜æ±° */

  /* ===== æ­·å²ç´€éŒ„å€ ===== */
  #history {
    height: 240px;
    overflow: auto;
    border: 1px solid #ddd;
    padding: 8px;
    background: #fafafa;
    margin-top: 10px;
    font-size: 14px;
  }
  .small {
    font-size: 13px;
    color: #666;
  }

  /* ===== è¨ˆåˆ†çµæœèˆ‡ Shootout ===== */
  .scorecard {
    margin-top: 10px;
    padding: 10px;
    border-radius: 8px;
    background: #f7f7f7;
    border: 1px solid #eee;
  }
  .shootout {
    margin-top: 12px;
    border: 1px dashed #ccc;
    padding: 8px;
    border-radius: 6px;
    background: #fff;
  }
  details summary {
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    margin-bottom: 6px;
  }

  /* æ¯”è³½çµæœè¡¨æ ¼æ¨£å¼ */
  .result-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 15px;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
  }
  .result-table th, .result-table td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }
  .result-table th {
    background: #f2f2f2;
    font-weight: bold;
  }
  .result-table td b {
    font-size: 16px;
    color: #333;
  }
  /* æ‰‹æ©Ÿç‰ˆï¼šç›´å‘é¡¯ç¤º */
  /* @media(max-width:600px){
    .result-table, .result-table thead, .result-table tbody, .result-table tr {
      display: block;
      width: 100%;
    }
    .result-table tr {
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }
    .result-table td, .result-table th {
      display: block;
      text-align: left;
      padding: 8px;
      border: none;
      border-bottom: 1px solid #eee;
    }
    .result-table td:last-child {
      border-bottom: none;
    }
  }
  */

@media screen and (max-width: 600px) {
  .result-table {
    display: flex;
    flex-direction: column;
    border-collapse: collapse;
    width: 100%;
  }

  .result-table tr {
    display: flex;
    flex-wrap: wrap;
    border-bottom: 1px solid #ccc;
    padding: 5px 0;
  }

  .result-table th,
  .result-table td {
    flex: 1 1 100%;
    padding: 5px;
    box-sizing: border-box;
  }

  .result-table tr:first-child {
    flex-direction: row;
  }

  .result-table tr:first-child th {
    flex: 1 1 33%;
    text-align: center;
  }

  .result-table tr td:nth-child(2),
  .result-table tr td:nth-child(3) {
    flex: 1 1 50%;
    text-align: left;
  }

  .result-table tr td:first-child {
    flex: 1 1 100%;
    font-weight: bold;
    margin-top: 10px;
  }
}


</style>
</head>
<body>
  
<div class="header-bar">
  <h1>Wiser Ball â€” è¨ˆåˆ†å™¨</h1>
  <div class="timer-block">
    æ¯”è³½è¨ˆæ™‚: <span id="timer">15:00</span>
    <button onclick="startTimer()">é–‹å§‹</button>
    <button onclick="pauseTimer()">æš«åœ</button>
    <button onclick="resetTimer()">é‡è¨­</button>
  </div>
</div>

<div id="matchArea">
<div id="matchInfo">
<!-- æ¯”è³½è³‡è¨Š -->
<details open>
  <summary>æ¯”è³½è³‡è¨Š</summary>
  <table class="match-info">
  <tr>
    <td>
      <label><span>åœ°é»</span><input type="text" id="location"></label>
      <label><span>å ´æ¬¡</span><input type="text" id="round"></label>
    </td>
    <td>
      <label><span>è¨ˆåˆ†å“¡</span><input type="text" id="scorer"></label>
      <label><span>è£åˆ¤å“¡</span><input type="text" id="referee"></label>
    </td>
  </tr>
  <tr>
    <td colspan="2">
      <label><span>æ—¥æœŸ</span><input type="date" id="matchDate"></label>
      <label><span>æ™‚é–“</span><input type="time" id="startTime"> ~ <input type="time" id="endTime"></label>
    </td>
  </tr>
  <tr>
    <td colspan="2">
      <div class="row">
        <label><span>ç´…çƒéšŠåï¼š</span><input id="teamAname" value="ç´…éšŠ"></label>
        <label><span>ç™½çƒéšŠåï¼š</span><input id="teamBname" value="ç™½éšŠ"></label>
        <label><span>æ¯éšŠçƒæ•¸ï¼š</span><input id="ballsPerTeam" type="number" value="7" min="1" max="7" style="width:70px"></label>
        <button id="btnInit" class="btn">å»ºç«‹å ´æ¬¡</button>
      </div>
    </td>
  </tr>
  </table>
</details>
</div>


<!-- æ§åˆ¶å€ -->
<div class="row controls">
  <label>æ”»æ“Šæ–¹: <select id="attTeam"></select></label>
  <label>æ”»æ“Šçƒè™Ÿ: <select id="attBall"></select></label>
  <label>ç›®æ¨™éšŠ: <select id="tgtTeam"></select></label>
  <label>ç›®æ¨™çƒè™Ÿ: <select id="tgtBall"></select></label>
<div class="action-row">
  <button id="btnHit" class="btn">åŸ·è¡Œæ“Šä¸­</button>
  <button id="btnUndo" class="btn">Undo Last</button>
 </div>
</div>

<!-- è¨ˆåˆ†æ¿ -->
<div class="board" id="boardArea"></div>

<div id="resultTableWrapper">
<!-- è¨ˆåˆ†çµæœ -->
<div id="scoreArea" class="scorecard" style="display:none"></div>
<!-- æ¯”è³½çµæœå€å¡Š -->
<details>
  <summary>æ¯”è³½çµæœ</summary>

  <!-- çµæŸæ¯”è³½æŒ‰éˆ• -->
  <div style="margin:10px 0;">
    <button id="btnCalc" class="btn">çµæŸæ¯”è³½ (è¨ˆåˆ†)</button>
    <button id="btnPdf" class="btn">ç”¢ç”Ÿ PDF</button>
  </div>

  <!-- çµæœè¡¨æ ¼ -->
  <table class="result-table" id="resultTable">
  <thead>
    <tr>
      <th>é …ç›®</th>
      <th id="resultTeamA">ç´…éšŠ</th>
      <th id="resultTeamB">ç™½éšŠ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ç«¶æŠ€</td>
      <td><span id="teamA_competitive">0</span> é¡†<br>åˆ†æ•¸ï¼š<span id="teamA_competitiveScore">0</span></td>
      <td><span id="teamB_competitive">0</span> é¡†<br>åˆ†æ•¸ï¼š<span id="teamB_competitiveScore">0</span></td>
    </tr>
    <tr>
      <td>åˆé—œ</td>
      <td><span id="teamA_firstLock">0</span> é¡†<br>åˆ†æ•¸ï¼š<span id="teamA_firstLockScore">0</span></td>
      <td><span id="teamB_firstLock">0</span> é¡†<br>åˆ†æ•¸ï¼š<span id="teamB_firstLockScore">0</span></td>
    </tr>
    <tr>
      <td>äºŒé—œ</td>
      <td><span id="teamA_secondLock">0</span> é¡†<br>åˆ†æ•¸ï¼š<span id="teamA_secondLockScore">0</span></td>
      <td><span id="teamB_secondLock">0</span> é¡†<br>åˆ†æ•¸ï¼š<span id="teamB_secondLockScore">0</span></td>
    </tr>
    <tr>
      <td><b>åŠ ç¸½åˆ†æ•¸</b></td>
      <td><b><span id="teamA_totalScore">0</span></b></td>
      <td><b><span id="teamB_totalScore">0</span></b></td>
    </tr>
    <!-- æ–°å¢ï¼šæ¯”è³½çµæœ -->
    <tr>
      <td><b>æ¯”è³½çµæœ</b></td>
      <td><span id="teamA_result">-</span></td>
      <td><span id="teamB_result">-</span></td>
    </tr>
    <!-- æ–°å¢ï¼šéšŠé•·ç°½å -->
    <tr>
      <td><b>éšŠé•·ç°½å</b></td>
      <td style="height:40px"></td>
      <td style="height:40px"></td>
    </tr>
  </tbody>
  </table>
</details>
</div>
</div>

<!-- æ­·å²ç´€éŒ„ -->
<div id="history" aria-live="polite"></div>

<!-- Shootout å€ -->
<div id="shootoutArea"></div>

<!-- JS ç¨‹å¼ç¢¼ï¼ˆä¿ç•™ä½ åŸæœ‰é‚è¼¯èˆ‡è¦å‰‡å¯¦ä½œï¼‰ -->
<script>
/*
 Implementation notes (ä¾æ‰‹å†Š):
 - ball.state: 0=ç«¶æŠ€çƒ,1=åˆé—œ(é»ƒ),2=äºŒé—œ(ç´…),3=æ·˜æ±°
 - ball.locked_by: array of attacker keys (strings "team-ball"), æ¯æ¬¡è¢«æ“Šä¸­å°± push(attackerKey)
   è§£é—œæ™‚è¦ç§»é™¤æŒ‡å®š attackerKey çš„é‚£å€‹ entryï¼ˆè‹¥å¤šå€‹ç”±å¤šæ¬¡æ“Šä¸­é€ æˆï¼‰
 - èª¤æ“Š: ç•¶ attacker.team == target.team æ™‚ -> attacker å‡ºå±€ (state=3),
   target.state +=1 ä¸¦æŠŠ locked_by.push("MIS-"+attackerKey)ï¼›è¦è§£æ•‘èª¤æ“Šç”¢ç”Ÿçš„è¢«é—œ
   éœ€è¦æ“Šä¸­ã€Œæ²’æœ‰é–ä½æˆ‘æ–¹ä»»ä½•çƒçš„å°æ–¹çƒã€ï¼Œæ­¤å¯¦ä½œæœƒåœ¨æ”»æ“Šå°æ–¹çƒæ™‚ï¼Œå…ˆçœ‹è©²è¢«æ“Šä¸­çƒ
   æ˜¯å¦æœ‰é–ä½æˆ‘æ–¹çƒï¼Œè‹¥æ²’æœ‰ï¼Œå‰‡æœƒç”¨è©²å‹•ä½œä¾†è§£æ•‘èª¤æ“Šè¢«é—œï¼ˆä¾æ‰‹å†Šè¦ç¯„ï¼‰ã€‚
 - åŠ æ¬Šè¨ˆåˆ†: ç«¶æŠ€çƒ=5, åˆé—œ=2, äºŒé—œ=1, æ·˜æ±°=0
 - è‹¥åŠ æ¬Šå¹³æ‰‹ -> é€²å…¥ 5 ç±³å®šé»çƒ (shootout)ï¼Œä»¥ 5 äººè¼ªæµï¼Œä»ç„¶å¹³æ‰‹é€²å…¥ sudden death
*/

let timerDuration = 90 * 60; // é è¨­ 90 åˆ†é˜ (ç§’æ•¸)
  let timer = timerDuration;
  let timerInterval = null;

  function updateDisplay() {
    let minutes = Math.floor(timer / 60);
    let seconds = timer % 60;
    document.getElementById("timer").innerText =
      String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
  }

  function startTimer() {
    if (timerInterval) return; // é¿å…é‡è¤‡å•Ÿå‹•
    timerInterval = setInterval(() => {
      if (timer > 0) {
        timer--;
        updateDisplay();
      } else {
        clearInterval(timerInterval);
        timerInterval = null;
        alert("â° æ¯”è³½æ™‚é–“åˆ°ï¼");
        // é€™è£¡å¯ä»¥è§¸ç™¼åŠ æ¬Šè¨ˆåˆ†
        calcWeightedScore();
      }
    }, 1000);

    // ğŸ”¹ æ–°å¢ log
    pushHistory("â±ï¸ è¨ˆæ™‚é–‹å§‹");
  }

  function pauseTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
    // ğŸ”¹ æ–°å¢ log
    pushHistory("â¸ï¸ è¨ˆæ™‚æš«åœ");
  }

  function resetTimer() {
    pauseTimer();
    timer = timerDuration;
    updateDisplay();
    // ğŸ”¹ æ–°å¢ log
    pushHistory("ğŸ”„ è¨ˆæ™‚é‡è¨­");
  }

  // åˆå§‹åŒ–é¡¯ç¤º
  updateDisplay();

//======================================================================
function addPause(team){
  state.stats[team].pause++;
  document.getElementById(`${team}-pause`).innerText = state.stats[team].pause;
  pushHistory(`${team} ä½¿ç”¨æš«åœ (ç´¯è¨ˆ ${state.stats[team].pause})`);
}

function addFoul(team){
  state.stats[team].foul++;
  document.getElementById(`${team}-foul`).innerText = state.stats[team].foul;
  pushHistory(`${team} çŠ¯è¦ (ç´¯è¨ˆ ${state.stats[team].foul})`);
}

function addSetup(team){
  if(state.stats[team].setup < 3){
    state.stats[team].setup++;
    document.getElementById(`${team}-setup`).innerText = state.stats[team].setup;
    pushHistory(`${team} ä½ˆçƒæ¬¡æ•¸ +1 (ç´¯è¨ˆ ${state.stats[team].setup})`);

    // å¦‚æœé”åˆ°3æ¬¡ â†’ éš±è— +1 æŒ‰éˆ•
    if(state.stats[team].setup >= 3){
      document.getElementById(`${team}-setup-btn`).style.display = "none";
    }
  }
}

function resetSetup(team){
  state.stats[team].setup = 0;
  document.getElementById(`${team}-setup`).innerText = state.stats[team].setup;
  pushHistory(`${team} é‡è¨­ä½ˆçƒæ¬¡æ•¸`);

  // é‡æ–°é¡¯ç¤º +1 æŒ‰éˆ•
  const btn = document.getElementById(`${team}-setup-btn`);
  if(btn) btn.style.display = "inline-block";
}


//=============================================================================
document.getElementById("btnInit").addEventListener("click", () => {
    initGame();

    const a = document.getElementById('teamAname').value || 'ç´…éšŠ';
    const b = document.getElementById('teamBname').value || 'ç™½éšŠ';
    const n = document.getElementById('ballsPerTeam').value || 7;
    pushHistory(`ğŸŸï¸ å»ºç«‹å ´æ¬¡ï¼š${a} vs ${b}ï¼Œæ¯éšŠ ${n} é¡†çƒ`);

    // é–ä½è¼¸å…¥æ¡†
    document.getElementById("teamAname").setAttribute("readonly", true);
    document.getElementById("teamBname").setAttribute("readonly", true);
    document.getElementById("ballsPerTeam").setAttribute("readonly", true);

    // ç¦ç”¨æŒ‰éˆ•
    document.getElementById("btnInit").disabled = true;

    
  });
//=============================================================================

let state = {
  teams: [],
  ballsPerTeam: 7,
  balls: {}, // key "Team-idx" => {team,id,state,locked_by:[]}
  history: [],
  undoStack: []
};

const WEIGHT = {0:5, 1:2, 2:1, 3:0}; // ä¾æ‰‹å†Š

function initGame(){
  const ta = document.getElementById('teamAname').value || 'A';
  const tb = document.getElementById('teamBname').value || 'B';
  const a = 'ç´…çƒ';
  const b = 'ç™½çƒ';
  const n = parseInt(document.getElementById('ballsPerTeam').value)||7;
  state.teams = [a,b];
  state.ballsPerTeam = n;
  state.balls = {};
  state.history = [];
  state.undoStack = [];
  for(const t of state.teams){
    for(let i=1;i<=n;i++){
      state.balls[`${t}-${i}`] = {team:t, id:i, state:0, locked_by:[]};
    }
  }
  renderSelectors();
  renderBoard();
  
  // ğŸ”¹ æ›´æ–°æ¯”è³½çµæœè¡¨çš„éšŠå
  document.getElementById("resultTeamA").innerText = ta;
  document.getElementById("resultTeamB").innerText = tb;
}

//æ”»æ“Šæ–¹ æ”¹è®Š â†’ æ”»æ“Šçƒè™Ÿ åªæœƒé¡¯ç¤ºã€Œç‹€æ…‹=ç«¶æŠ€ã€çš„çƒè™Ÿ
//ç›®æ¨™éšŠ æ”¹è®Š â†’ ç›®æ¨™çƒè™Ÿ åªæœƒé¡¯ç¤ºã€Œæœªæ·˜æ±° (state < 3)ã€çš„çƒ

function renderSelectors(){
  const attT = document.getElementById('attTeam');
  const tgtT = document.getElementById('tgtTeam');
  const attB = document.getElementById('attBall');
  const tgtB = document.getElementById('tgtBall');

  // æ¸…ç©ºä¸‹æ‹‰
  attT.innerHTML=''; 
  tgtT.innerHTML='';
  attB.innerHTML=''; 
  tgtB.innerHTML='';

  // å¡«å…¥éšŠä¼é¸é …
  for(const t of state.teams){ 
    attT.append(new Option(t,t)); 
    tgtT.append(new Option(t,t)); 
  }

  // é è¨­é¡¯ç¤ºç¬¬ä¸€éšŠçš„åˆæ³•æ”»æ“Šçƒ
  updateAttackerBalls();

  // ç¶å®šäº‹ä»¶ â†’ ç•¶æ”»æ“Šæ–¹è®Šæ›´æ™‚ï¼Œæ›´æ–°æ”»æ“Šçƒè™Ÿé¸å–®
  attT.onchange = updateAttackerBalls;
  tgtT.onchange = updateTargetBalls;

  // åˆå§‹åŒ–ç›®æ¨™çƒ
  updateTargetBalls();

  // ---- å…§éƒ¨å‡½å¼ ----
  function updateAttackerBalls(){
    attB.innerHTML = '';
    const team = attT.value;
    for(let i=1;i<=state.ballsPerTeam;i++){
      const b = state.balls[`${team}-${i}`];
      if(b && b.state === 0){   // åªåˆ—å‡ºã€Œç«¶æŠ€ã€ç‹€æ…‹çš„çƒ
        attB.append(new Option(i,i));
      }
    }
  }

  function updateTargetBalls(){
    tgtB.innerHTML = '';
    const team = tgtT.value;
    for(let i=1;i<=state.ballsPerTeam;i++){
      const b = state.balls[`${team}-${i}`];
      if(b && b.state < 3){   // ç›®æ¨™åªè¦é‚„æ²’æ·˜æ±°çš„çƒ
        tgtB.append(new Option(i,i));
      }
    }
  }
}


function renderBoard(){
  const area = document.getElementById('boardArea');
  area.innerHTML = '';

  for(const t of state.teams){
    // åˆå§‹åŒ–éšŠä¼çµ±è¨ˆè³‡æ–™
    if(!state.stats) state.stats = {};
    if(!state.stats[t]) {
      state.stats[t] = {pause:0, foul:0, setup:0};
    }

    const card = document.createElement('div');
    card.className='team-card';

    // ğŸ”¹ Headerï¼šç³»çµ±éšŠå (ç´…çƒ/ç™½çƒ) + ä½¿ç”¨è€…è¼¸å…¥çš„éšŠå
    const headerRow = document.createElement('div');
    headerRow.style.display = "flex";
    headerRow.style.justifyContent = "space-between";
    headerRow.style.alignItems = "center";
    headerRow.style.marginBottom = "6px";
    headerRow.style.flexWrap = "wrap"; // RWDï¼Œè‡ªå‹•æ›è¡Œ

    const h = document.createElement('h3');
    h.textContent = `${t}`; // ç³»çµ±éšŠå
    h.style.margin = "0";

    const teamNameLabel = document.createElement('div');
    teamNameLabel.textContent = (t === state.teams[0]) 
      ? document.getElementById('teamAname').value 
      : document.getElementById('teamBname').value;
    teamNameLabel.style.fontWeight = "bold";
    teamNameLabel.style.fontSize = "16px";
    teamNameLabel.style.textAlign = "center";
    teamNameLabel.style.flex = "1"; // è®“å®ƒç½®ä¸­å°é½Š
    teamNameLabel.style.minWidth = "120px";

    headerRow.appendChild(h);
    headerRow.appendChild(teamNameLabel);
    card.appendChild(headerRow);

    // ğŸ”¹ çƒç‹€æ…‹
    const ballsWrap = document.createElement('div');
    ballsWrap.className='balls';
    for(let i=1;i<=state.ballsPerTeam;i++){
      const key = `${t}-${i}`;
      const b = state.balls[key];
      const el = document.createElement('div');
      el.className = `ball s${b.state}`;
      let lab = `${b.id}: `;
      if(b.state===0) lab += 'ç«¶æŠ€';
      else if(b.state===1) lab += 'åˆé—œ(é»ƒ)';
      else if(b.state===2) lab += 'äºŒé—œ(ç´…)';
      else lab += 'æ·˜æ±°';
      el.innerHTML = `<div style="font-weight:700">${lab}</div>
        <div class="small">locked by: ${b.locked_by.join(', ')||'-'}</div>`;
      ballsWrap.appendChild(el);
    }
    card.appendChild(ballsWrap);

    // ğŸ”¹ æš«åœ / çŠ¯è¦ / ä½ˆçƒ
    const controls = document.createElement('div');
    controls.style.marginTop = "10px";
    controls.innerHTML = `
      <div><b>æš«åœ:</b> <span id="${t}-pause">${state.stats[t].pause}</span> 
        <button onclick="addPause('${t}')">+1</button></div>
      <div><b>çŠ¯è¦:</b> <span id="${t}-foul">${state.stats[t].foul}</span> 
        <button onclick="addFoul('${t}')">+1</button></div>
      <div><b>ä½ˆçƒ:</b> 
        <span id="${t}-setup">${state.stats[t].setup}</span> 
        <button id="${t}-setup-btn" onclick="addSetup('${t}')">+1</button> 
        <button onclick="resetSetup('${t}')">Reset</button>
      </div>
    `;
    card.appendChild(controls);

    area.appendChild(card);

    // ğŸ”¹ æª¢æŸ¥ä½ˆçƒé” 3 æ¬¡ â†’ éš±è— +1 æŒ‰éˆ•
    if(state.stats[t].setup >= 3){
      const btn = document.getElementById(`${t}-setup-btn`);
      if(btn) btn.style.display = "none";
    }
  }

  // ğŸ”¹ æ›´æ–°æ­·å²ç´€éŒ„
  const hist = document.getElementById('history');
  hist.innerHTML = state.history.slice().reverse().map(x=>`<div>${x}</div>`).join('');
  document.getElementById('scoreArea').style.display='none';
  document.getElementById('shootoutArea').innerHTML='';
}


function keyOf(team, id){ return `${team}-${id}`; }

function doHit(attTeam, attBall, tgtTeam, tgtBall){
  const aKey = keyOf(attTeam, attBall);
  const tKey = keyOf(tgtTeam, tgtBall);
  const attacker = state.balls[aKey];
  const target = state.balls[tKey];
  if(!attacker || !target){ alert('çƒä¸å­˜åœ¨'); return; }
  // save for undo (deep-ish copy)
  state.undoStack.push(JSON.stringify(state.balls));
  // Ignore hits if attacker eliminated
  if(attacker.state >=3){
    pushHistory(`${aKey} ä¼åœ–æ”»æ“Š ${tKey} ä½†æ”»æ“Šè€…å·²æ·˜æ±°ï¼ˆç„¡æ•ˆï¼‰`);
    return;
  }
  // If target already eliminated -> no effect
  if(target.state >=3){
    pushHistory(`${aKey} æ”»æ“Š ${tKey} ä½†ç›®æ¨™å·²æ·˜æ±°ï¼ˆç„¡æ•ˆï¼‰`);
    return;
  }

  // Case: mis-hit (same team)
  if(attacker.team === target.team){
    // attacker out
    attacker.state = 3;
    pushHistory(`${aKey} èª¤æ“Š ${tKey} -> èª¤æ“Šè€… ${aKey} å‡ºå±€ï¼›${tKey} è¢«åˆé—œ/åŠ é—œ`);
    // Increase target state by 1 (unless already eliminated) and record MIS lock
    if(target.state < 3){
      target.state = Math.min(3, target.state + 1);
      // mark MIS lock with prefix so we can differentiate
      target.locked_by.push(`MIS-${aKey}`);
      if(target.state>=3){
        // fully eliminated: clear locked_by (per manual it's out)
        // leave locked_by cleared
        target.locked_by = [];
        pushHistory(`${tKey} å·²è¢«èª¤æ“Šå‡ºå±€`);
      } else {
        pushHistory(`${tKey} ç¾åœ¨ç‚º ${target.state===1? 'åˆé—œ(é»ƒ)':'äºŒé—œ(ç´…)'} (è¢« MIS-${aKey})`);
      }
    }
    // Also, rule: when a team member hits an opponent ball, that may free mis-hit locked balls
    renderBoard();
    return;
  }

  // Normal attack: attacker hits opponent's ball
  // Add attacker key to target.locked_by
  target.locked_by.push(aKey);
  // If target was locked_by mis entries? We'll handle è§£é—œ logic below.
  // If this opponent ball (the one being hit) currently locks any of attacker's team balls, then hitting it will free those.
  // But first, increment target state
  target.state = Math.min(3, target.state + 1);
  if(target.state>=3){
    // eliminated: clear locked_by
    target.locked_by = [];
    pushHistory(`${aKey} æ“Šä¸­ ${tKey} -> æ·˜æ±°`);
  } else {
    pushHistory(`${aKey} æ“Šä¸­ ${tKey} -> ${target.state===1? 'åˆé—œ(é»ƒ)':'äºŒé—œ(ç´…)'} (locked_by  ${aKey})`);
  }

  // è§£é—œæª¢æŸ¥ï¼šç•¶æŸéšŠæ“Šä¸­å°æ–¹çƒ X æ™‚ï¼Œè¦æª¢æŸ¥æ˜¯å¦å› æ­¤å¯ä»¥è§£æ•‘æˆ‘æ–¹è¢« X é–ä½çš„çƒ
  // (è‹¥è¢«æ“Šä¸­çš„çƒ (tKey) æ›¾é–ä½æ”»æ“Šæ–¹çš„æŸé¡†çƒï¼Œå‰‡ç§»é™¤å…¶åœ¨é‚£é¡†çƒ locked_by çš„å°æ‡‰ entry ä¸¦æ¸›å°‘è©²çƒç‹€æ…‹)
  // æ‰¾åˆ°æ”»æ“Šè€…éšŠä¼ä¸­ä»»ä¸€çƒå…¶ locked_by åŒ…å« tKey (ä¹Ÿå°±æ˜¯é‚£é¡†è¢«æ“Šä¸­çƒåŸæœ¬é–ä½æˆ‘æ–¹çƒ)ï¼š
  const myTeam = attacker.team;
  const oppTeam = target.team;
  let freedAny = 0;
  // iterate my team balls and remove one entry per matching
  for(let i=1;i<=state.ballsPerTeam;i++){
    const bk = `${myTeam}-${i}`;
    const myBall = state.balls[bk];
    // find index of tKey in locked_by
    const idx = myBall.locked_by.indexOf(tKey);
    if(idx !== -1){
      // remove one instance
      myBall.locked_by.splice(idx,1);
      // decrement its state by 1 (but not below 0)
      if(myBall.state>0) myBall.state = myBall.state - 1;
      freedAny++;
      pushHistory(`${aKey} æ“Šä¸­ ${tKey} ï¼Œè§£æ•‘äº†æˆ‘æ–¹ ${bk}ï¼ˆè¢« ${tKey} æ‰€é—œï¼‰ -> ${myBall.state===0? 'ç«¶æŠ€':'åˆé—œ/äºŒé—œ'} `);
      
      // NOTE: peræ‰‹å†Šï¼Œä¸€æ¬¡æ“Šä¸­å¯è§£æ•‘ä¸€é¡†è¢«è©²çƒé—œä½çš„æˆ‘æ–¹çƒï¼›ç¹¼çºŒå°‹æ‰¾å…¶ä»–è¢«åŒä¸€çƒé—œä½çš„ï¼ˆè‹¥å¤šå€‹å‰‡æœƒé€å€‹è§£æ•‘ï¼‰
      // continue to search: keep freeing as long as target ball tKey had been locking my balls
    }
  }
  // å¦‚æœæ²’æœ‰ freedAnyï¼Œä¾æ‰‹å†Šè¦å®šï¼šè‹¥è©²è¢«æ“Šä¸­çƒä¸¦æ²’æœ‰é–ä½æˆ‘æ–¹ä»»ä½•çƒï¼Œä½†æˆ‘æ–¹æœ‰å› ã€Œèª¤æ“Šã€è€Œè¢«é—œçš„çƒ
  // é‚£éº¼å¯ç”¨æ“Šä¸­ä¸€é¡†ä¸é–ä½ä»»ä½•æˆ‘æ–¹çƒçš„å°æ–¹çƒä¾†è§£æ•‘èª¤æ“Šæ‰€é—œä½çš„çƒ
  if(freedAny===0){
    // find if attacker.team æœ‰å›  MIS è€Œè¢«é—œçš„çƒ
    let misLockedBalls = [];
    for(let i=1;i<=state.ballsPerTeam;i++){
      const bk = `${myTeam}-${i}`;
      const myBall = state.balls[bk];
      // if locked_by contains an entry starting with MIS-
      if(myBall.locked_by.some(x=>x.startsWith('MIS-'))){
        misLockedBalls.push(bk);
      }
    }
    if(misLockedBalls.length>0){
      // But per rule we may only use this hit to free MIS if the hit opponent ball (tKey) is NOT currently locking any myTeam ball.
      // Make sure tKey isn't currently in locked_by of any of my team balls (we already tested above)
      let tkeyLocksAny = false;
      for(let i=1;i<=state.ballsPerTeam;i++){
        const bk = `${myTeam}-${i}`;
        const myBall = state.balls[bk];
        if(myBall.locked_by.includes(tKey)) { tkeyLocksAny = true; break; }
      }
      if(!tkeyLocksAny){
        // free one mis-locked ball (å…ˆå‰è¢«èª¤æ“Šçš„é‚£é¡†). æ‰¾å‡ºç¬¬ä¸€å€‹æœ‰ MIS- çš„
        for(let i=1;i<=state.ballsPerTeam;i++){
          const bk = `${myTeam}-${i}`;
          const myBall = state.balls[bk];
          const midx = myBall.locked_by.findIndex(x=>x.startsWith('MIS-'));
          if(midx!==-1){
            // remove that MIS entry
            myBall.locked_by.splice(midx,1);
            // decrement its state by 1
            if(myBall.state>0) myBall.state = myBall.state - 1;
            pushHistory(`${aKey} æ“Šä¸­ ${tKey} (æœªé–æˆ‘æ–¹çƒ) -> è§£æ•‘äº†å› èª¤æ“Šè¢«é—œçš„æˆ‘æ–¹ ${bk}`);
            break;
          }
        }
      }
    }
  }

  renderBoard();
}


document.getElementById('btnHit').addEventListener('click', ()=>{
  const attTeam = document.getElementById('attTeam').value;
  const attBall = Number(document.getElementById('attBall').value);
  const tgtTeam = document.getElementById('tgtTeam').value;
  const tgtBall = Number(document.getElementById('tgtBall').value);
  doHit(attTeam, attBall, tgtTeam, tgtBall);
});
document.getElementById('btnUndo').addEventListener('click', ()=>{
  if(state.undoStack.length===0){ alert('ç„¡å¯é‚„åŸå‹•ä½œ'); return;}
  const prev = state.undoStack.pop();
  state.balls = JSON.parse(prev);
  pushHistory('å·²é‚„åŸä¸Šä¸€æ­¥å‹•ä½œ (undo)');
  renderBoard();
});

//ç”¢ç”Ÿpdf
document.getElementById("btnPdf").addEventListener("click", () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "pt", "a4");

  const target = document.getElementById("matchArea");

  // ğŸ”¹ å…ˆéš±è—æŒ‰éˆ•
  const buttons = target.querySelectorAll("button");
  buttons.forEach(btn => btn.style.display = "none");

  // ğŸ”¹ æš«æ™‚å›ºå®šå¯¬åº¦ï¼Œé¿å…æ‰‹æ©Ÿç•«é¢æ“ å£“
  target.style.width = "800px";

  html2canvas(target, { scale: 2 }).then((canvas) => {
    // æˆªåœ–å¾Œé‚„åŸå¯¬åº¦
    target.style.width = "";
    // æˆªåœ–å¾Œæ¢å¾©æŒ‰éˆ•
    buttons.forEach(btn => btn.style.display = "inline-block");

    const imgData = canvas.toDataURL("image/png");
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    const marginTop = 42;   // 1.5cm
    const marginLeft = 28;  // 1cm
    const marginRight = 28; // 1cm

    const pdfWidth = pageWidth - marginLeft - marginRight;
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

    doc.addImage(imgData, "PNG", marginLeft, marginTop, pdfWidth, pdfHeight);

    // æª”å wiser_YYYYMMDD_HHmmss.pdf
    const now = new Date();
    const filename = `wiser_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}_${String(now.getHours()).padStart(2,"0")}${String(now.getMinutes()).padStart(2,"0")}${String(now.getSeconds()).padStart(2,"0")}.pdf`;
    doc.save(filename);
  });
});



// history log
function pushHistory(text){
  const timestamp = new Date().toLocaleTimeString();
  state.history.push(`${timestamp} â€” ${text}`);
  if(state.history.length > 1000) state.history.shift();
  renderBoard();
}

// compute weighted score
function computeWeighted(){
  const teamScores = {};
  for(const t of state.teams){
    teamScores[t] = {counts:{0:0,1:0,2:0,3:0}, score:0};
  }
  for(const key in state.balls){
    const b = state.balls[key];
    teamScores[b.team].counts[b.state] += 1;
  }
  for(const t of state.teams){
    const c = teamScores[t].counts;
    teamScores[t].score = c[0]*WEIGHT[0] + c[1]*WEIGHT[1] + c[2]*WEIGHT[2] + c[3]*WEIGHT[3];
  }
  return teamScores;
}

document.getElementById('btnCalc').addEventListener('click', ()=>{
  const scores = computeWeighted();
  
  // å–éšŠåï¼ˆä½¿ç”¨è€…è¼¸å…¥ï¼‰
  const teamA = state.teams[0];
  const teamB = state.teams[1];

  // å¡«å…¥ç«¶æŠ€æ•¸é‡èˆ‡åˆ†æ•¸
  document.getElementById('teamA_competitive').innerText = scores[teamA].counts[0];
  document.getElementById('teamB_competitive').innerText = scores[teamB].counts[0];
  document.getElementById('teamA_competitiveScore').innerText = scores[teamA].counts[0] * 5;
  document.getElementById('teamB_competitiveScore').innerText = scores[teamB].counts[0] * 5;

  // å¡«å…¥åˆé—œ
  document.getElementById('teamA_firstLock').innerText = scores[teamA].counts[1];
  document.getElementById('teamB_firstLock').innerText = scores[teamB].counts[1];
  document.getElementById('teamA_firstLockScore').innerText = scores[teamA].counts[1] * 2;
  document.getElementById('teamB_firstLockScore').innerText = scores[teamB].counts[1] * 2;

  // å¡«å…¥äºŒé—œ
  document.getElementById('teamA_secondLock').innerText = scores[teamA].counts[2];
  document.getElementById('teamB_secondLock').innerText = scores[teamB].counts[2];
  document.getElementById('teamA_secondLockScore').innerText = scores[teamA].counts[2] * 1;
  document.getElementById('teamB_secondLockScore').innerText = scores[teamB].counts[2] * 1;

  // åŠ ç¸½åˆ†æ•¸
  document.getElementById('teamA_totalScore').innerText = scores[teamA].score;
  document.getElementById('teamB_totalScore').innerText = scores[teamB].score;

  // åˆ¤å®šå‹è² æˆ–å¹³æ‰‹
  const s0 = scores[teamA].score;
  const s1 = scores[teamB].score;

  if(s0 > s1){
    document.getElementById("teamA_result").innerText = "å‹";
    document.getElementById("teamB_result").innerText = "æ•—";
    pushHistory(`æ¯”è³½çµæŸï¼š${teamA} ä»¥ ${s0} vs ${s1} ç²å‹`);
    //alert(`${teamA} ç²å‹ï¼ (${s0} vs ${s1})`);
  } else if(s1 > s0){
    document.getElementById("teamA_result").innerText = "æ•—";
    document.getElementById("teamB_result").innerText = "å‹";
    pushHistory(`æ¯”è³½çµæŸï¼š${teamB} ä»¥ ${s1} vs ${s0} ç²å‹`);
    //alert(`${teamB} ç²å‹ï¼ (${s1} vs ${s0})`);
  } else {
    document.getElementById("teamA_result").innerText = "å¹³æ‰‹";
    document.getElementById("teamB_result").innerText = "å¹³æ‰‹";
    pushHistory(`åŠ æ¬Šåˆ†å¹³æ‰‹ (${s0} vs ${s1})ï¼Œé€²å…¥ 5 ç±³å®šé»çƒ`);
    //alert(`å¹³æ‰‹ (${s0} vs ${s1}) â†’ é€²å…¥ 5 ç±³å®šé»çƒ (Shootout)`);
    
    setTimeout(()=> startShootout(), 100);
  }

  area.innerHTML = html;
  renderBoard();
});

// --- Shootout (5 ç±³å®šé»çƒ) ----
// We'll implement interactive 5-shot each; then sudden death if still tie.
let shootout = {
  active:false,
  order:[], // arrays of players keys for each team for shootout order (strings)
  idxA:0, idxB:0,
  resultsA:[], resultsB:[],
  nextTurnTeam: null,
  round: 1,
  maxRound:5
};

function startShootout(){
  // ask user to set the 5-player order for each team; to simplify we will use 1..min(7,balls) order or allow custom via prompt
  const tA = state.teams[0], tB = state.teams[1];
  const n = Math.min(state.ballsPerTeam,5);
  // default order: 1..n
  shootout.order = [];
  shootout.order[0] = [];
  shootout.order[1] = [];
  for(let i=1;i<=n;i++){
    shootout.order[0].push(`${tA}-${i}`);
    shootout.order[1].push(`${tB}-${i}`);
  }
  shootout.resultsA = Array(n).fill(null);
  shootout.resultsB = Array(n).fill(null);
  shootout.active = true;
  shootout.nextTurnTeam = 0; // team index 0 starts? Manual says toss to decide; we'll default team0 first and show option to swap
  renderShootoutUI();
}

function renderShootoutUI(){
  const area = document.getElementById('shootoutArea');
  if(!shootout.active){ area.innerHTML=''; return; }
  const tA = state.teams[0], tB = state.teams[1];
  let html = `<div class="shootout"><h4>5ç±³å®šé»çƒ (Shootout)</h4>
    <div class="small">ï¼ˆæŒ‰é †åºè¼ªæµï¼Œé è¨­ ${tA} å…ˆï¼‰</div>
    <div style="display:flex;gap:12px;margin-top:8px">
      <div style="flex:1">
        <div><b>${tA}</b></div>
        ${shootout.order[0].map((p,i)=>`<div>${p}ï¼š ${renderHitBtn('A',i)}</div>`).join('')}
      </div>
      <div style="flex:1">
        <div><b>${tB}</b></div>
        ${shootout.order[1].map((p,i)=>`<div>${p}ï¼š ${renderHitBtn('B',i)}</div>`).join('')}
      </div>
    </div>

    <div style="margin-top:10px">
      <button onclick="toggleShootoutStarter()" class="btn">æ›é‚Šï¼ˆæ”¹ç”± ${state.teams[ shootout.nextTurnTeam===0?1:0 ]} å…ˆï¼‰</button>
      <button onclick="finalizeShootout()" class="btn">çµæŸ shootoutï¼ˆè‹¥å·²å®Œæˆï¼‰</button>
    </div>
  </div>`;
  area.innerHTML = html;
}

function renderHitBtn(teamChar, idx){
  // teamChar 'A' or 'B'
  const ti = teamChar==='A'?0:1;
  const res = ti===0? shootout.resultsA[idx] : shootout.resultsB[idx];
  if(res===null) return `<button onclick="recordShootout(${ti},${idx},true)" class="btn">å‘½ä¸­</button>
                        <button onclick="recordShootout(${ti},${idx},false)" class="btn danger">æœªä¸­</button>`;
  return res? `<span style="color:green">å‘½ä¸­</span>` : `<span style="color:#777">æœªä¸­</span>`;
}

function recordShootout(teamIdx, idx, hit){
  if(!shootout.active) return;
  if(teamIdx===0) shootout.resultsA[idx] = hit;
  else shootout.resultsB[idx] = hit;
  pushHistory(`Shootout: ${ (teamIdx===0? state.teams[0]:state.teams[1]) } ${ (teamIdx===0? shootout.order[0][idx] : shootout.order[1][idx]) } -> ${hit? 'å‘½ä¸­':'æœªä¸­' }`);
  renderShootoutUI();
}

function toggleShootoutStarter(){
  shootout.nextTurnTeam = 1 - shootout.nextTurnTeam;
  renderShootoutUI();
}

function finalizeShootout(){
  // compute totals of first 5
  const n = shootout.order[0].length;
  let sumA = shootout.resultsA.reduce((acc,v)=>acc + (v?1:0), 0);
  let sumB = shootout.resultsB.reduce((acc,v)=>acc + (v?1:0), 0);
  if(sumA>sumB){
    pushHistory(`Shootout çµæœï¼š${state.teams[0]} ä»¥ ${sumA} vs ${sumB} å‹å‡º`);
    alert(`Shootoutï¼š${state.teams[0]} å‹ (${sumA} vs ${sumB})`);
  } else if(sumB>sumA){
    pushHistory(`Shootout çµæœï¼š${state.teams[1]} ä»¥ ${sumB} vs ${sumA} å‹å‡º`);
    alert(`Shootoutï¼š${state.teams[1]} å‹ (${sumB} vs ${sumA})`);
  } else {
    // sudden death: allow additional single-turn throws by original order until tie broken
    const tie = confirm(`5äººè¼ªæµå¾Œä»å¹³æ‰‹ (${sumA} vs ${sumB})ã€‚æ˜¯å¦é€²å…¥é©Ÿæ­» (Sudden Death)ï¼ŸæŒ‰ã€Œç¢ºå®šã€é–‹å§‹é©Ÿæ­»æ‰‹å‹•è¨˜éŒ„ï¼ˆæ¯éšŠä¸€æ¬¡äº’æ›ï¼‰ã€‚`);
    if(tie){
      // We'll let user manually record one-by-one more throws by using same UI (they can presså‘½ä¸­/æœªä¸­ for next null slot by adding to arrays)
      // append one more slot
      shootout.order[0].push(`${state.teams[0]}-SD${shootout.order[0].length+1}`);
      shootout.order[1].push(`${state.teams[1]}-SD${shootout.order[1].length+1}`);
      shootout.resultsA.push(null); shootout.resultsB.push(null);
      renderShootoutUI();
      return;
    } else {
      pushHistory('Shootout çµæŸä½†ä»å¹³æ‰‹ï¼Œæœªé€²è¡Œé©Ÿæ­»');
      alert('Shootout still tied and no sudden death performed.');
    }
  }
  shootout.active = false;
  renderShootoutUI();
}

// init on load
initGame();

</script>
</body>
</html>
